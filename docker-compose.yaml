name: public-detective

services:
  postgres:
    image: postgres:16-alpine
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: postgres
      POSTGRES_DB: public_detective
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --lc-collate=en_US.UTF-8 --lc-ctype=en_US.UTF-8"
      LANG: en_US.UTF-8
      LC_ALL: en_US.UTF-8
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d public_detective"]
      interval: 5s
      timeout: 5s
      retries: 5

  pubsub:
    image: google/cloud-sdk:emulators
    command: >
      gcloud beta emulators pubsub start
      --project=public-detective
      --host-port=0.0.0.0:8085
      --log-http
    ports:
      - "8085:8085"
    volumes:
      - pubsub_data:/data

  gcs:
    image: fsouza/fake-gcs-server:latest
    command: -scheme http -host 0.0.0.0 -port 8086
    ports:
      - "8086:8086"
    volumes:
      - gcs_data:/data

  gcp-init:
    image: google/cloud-sdk:emulators
    command: >
      sh -c "
        echo 'Configuring gcloud CLI...';
        gcloud config set auth/disable_credentials true;
        gcloud config set project public-detective;
        gcloud config set api_endpoint_overrides/pubsub http://pubsub:8085/ --quiet;
        gcloud config set api_endpoint_overrides/storage http://gcs:8086/storage/v1/ --quiet;

        echo 'Waiting for Pub/Sub emulator to be ready...';
        until gcloud pubsub topics list > /dev/null 2>&1; do
          echo -n '.' && sleep 1;
        done;
        echo ' Pub/Sub is ready.';

        echo 'Waiting for GCS emulator to be ready...';
        until curl -s --fail http://gcs:8086/storage/v1/b > /dev/null 2>&1; do
          echo -n '.' && sleep 1;
        done;
        echo ' GCS is ready.';

        echo '----------';
        echo 'Creating main topic...';
        gcloud pubsub topics create procurements || echo 'Topic procurements already exists.';

        echo 'Creating dead-letter topic...';
        gcloud pubsub topics create procurements-dlq || echo 'Topic procurements-dlq already exists.';

        echo '----------';
        echo 'Creating main subscription with DLQ policy...';
        gcloud pubsub subscriptions create procurements-subscription --topic procurements --dead-letter-topic procurements-dlq --max-delivery-attempts 5 || echo 'Subscription procurements-subscription already exists.';

        echo '----------';
        echo 'Creating GCS Bucket...';
        gcloud storage buckets create gs://procurements || echo 'Bucket procurements already exists.';

        echo '----------';
        echo 'Initialization complete.';
      "
    depends_on:
      postgres:
        condition: service_healthy
      pubsub:
        condition: service_started
      gcs:
        condition: service_started


volumes:
  postgres_data:
  pubsub_data:
  gcs_data:
