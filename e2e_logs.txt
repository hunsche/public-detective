============================= test session starts ==============================
platform linux -- Python 3.12.11, pytest-8.4.1, pluggy-1.6.0
rootdir: /app
configfile: pytest.ini
plugins: Faker-25.9.2, timeout-2.4.0, cov-5.0.0, rerunfailures-14.0, mock-3.14.1, xdist-3.8.0, dotenv-0.5.2, asyncio-0.24.0
asyncio: mode=Mode.AUTO, default_loop_scope=None
collected 1 item

tests/e2e/test_full_e2e.py
--- Setting up database session ---
Creating schema test_schema_2c04cb675eb94b669891715333093917...
Running Alembic migrations...

--- Running command: poetry run alembic upgrade head ---
INFO  [alembic.runtime.migration] Context impl PostgresqlImpl.
INFO  [alembic.runtime.migration] Will assume transactional DDL.
INFO  [alembic.runtime.migration] Running upgrade  -> 9594c79c1cd3, Revision ID: 9594c79c1cd3
Revises:
Create Date: 2025-08-31 23:56:00.000000
Alembic: Migrating within schema: test_schema_2c04cb675eb94b669891715333093917
--- Command finished: poetry run alembic upgrade head ---

--- Setting up E2E test environment ---
Creating Pub/Sub topic: projects/public-detective/topics/procurements-topic-604ad3f3baec48cdb47e67b7bfe370a0
Creating Pub/Sub subscription: projects/public-detective/subscriptions/procurements-subscription-604ad3f3baec48cdb47e67b7bfe370a0
Truncating tables before test run...
Tables truncated.

--- Starting E2E test flow ---

--- Running command: poetry run python -m source.cli pre-analyze --start-date 2025-08-23 --end-date 2025-08-23 --max-messages 2 ---
2025-09-02 15:21:48 - public_detective - [INFO] [-] - Logger configured with level: INFO
Running pre-analysis from 2025-08-23 to 2025-08-23.
2025-09-02 15:21:49 - public_detective - [INFO] [-] - Database engine not found, creating new instance...
2025-09-02 15:21:49 - public_detective - [INFO] [-] - Using isolated schema: test_schema_2c04cb675eb94b669891715333093917
2025-09-02 15:21:49 - public_detective - [INFO] [-] - SQLAlchemy engine created successfully.
2025-09-02 15:21:49 - public_detective - [INFO] [-] - Google Gemini client configured successfully for schema 'Analysis'.
2025-09-02 15:21:49 - public_detective - [INFO] [-] - Starting pre-analysis job for date range: 2025-08-23 to 2025-08-23
2025-09-02 15:21:49 - public_detective - [INFO] [-] - Processing date: 2025-08-23
2025-09-02 15:21:49 - public_detective - [INFO] [-] - Fetching all procurements updated on 2025-08-23 with raw data...
2025-09-02 15:21:49 - public_detective - [INFO] [-] - Searching for city with IBGE code: 3550308
2025-09-02 15:21:52 - public_detective - [INFO] [-] - Finished fetching. Total procurements: 3
2025-09-02 15:21:52 - public_detective - [INFO] [-] - Processing batch 1 with 3 procurements.
2025-09-02 15:21:52 - public_detective - [INFO] [-] - Processing procurement 43776491000170-1-000251/2025
2025-09-02 15:21:53 - public_detective - [INFO] [-] - Found metadata for 3 active document(s).
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Calculated procurement hash: 549a0639e0644e4ca5b01e3be17a36eda3aef2f69b6e44980154ed1903c3aa97
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Calculated procurement hash: 549a0639e0644e4ca5b01e3be17a36eda3aef2f69b6e44980154ed1903c3aa97
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Saving procurement 43776491000170-1-000251/2025 version 1 to the database.
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Procurement version saved successfully.
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Counting tokens for analysis...
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Estimated token count: 2973
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Saving pre-analysis for 43776491000170-1-000251/2025 version 1.
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Pre-analysis saved successfully with ID: 5cb0a208-06ad-4c45-88e6-e921778363d1.
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Recording new status 'PENDING_ANALYSIS' for analysis_id 5cb0a208-06ad-4c45-88e6-e921778363d1.
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Status history record created successfully.
2025-09-02 15:21:59 - public_detective - [INFO] [-] - Processing procurement 43776491000170-1-000252/2025
2025-09-02 15:22:00 - public_detective - [INFO] [-] - Found metadata for 3 active document(s).
2025-09-02 15:22:07 - public_detective - [INFO] [-] - Calculated procurement hash: ac4ee5db98b436504d028a31c771ed930d941803cf71f903fc130ec03ada2c85
2025-09-02 15:22:07 - public_detective - [INFO] [-] - Calculated procurement hash: ac4ee5db98b436504d028a31c771ed930d941803cf71f903fc130ec03ada2c85
2025-09-02 15:22:07 - public_detective - [INFO] [-] - Saving procurement 43776491000170-1-000252/2025 version 1 to the database.
2025-09-02 15:22:07 - public_detective - [INFO] [-] - Procurement version saved successfully.
2025-09-02 15:22:07 - public_detective - [INFO] [-] - Counting tokens for analysis...
2025-09-02 15:22:09 - public_detective - [INFO] [-] - Estimated token count: 6330
2025-09-02 15:22:09 - public_detective - [INFO] [-] - Saving pre-analysis for 43776491000170-1-000252/2025 version 1.
2025-09-02 15:22:09 - public_detective - [INFO] [-] - Pre-analysis saved successfully with ID: bb5346ea-31c6-450a-b6b2-025196ade101.
2025-09-02 15:22:09 - public_detective - [INFO] [-] - Recording new status 'PENDING_ANALYSIS' for analysis_id bb5346ea-31c6-450a-b6b2-025196ade101.
2025-09-02 15:22:09 - public_detective - [INFO] [-] - Status history record created successfully.
2025-09-02 15:22:09 - public_detective - [INFO] [-] - Reached max_messages (2). Stopping pre-analysis.
Pre-analysis completed successfully!
--- Command finished: poetry run python -m source.cli pre-analyze --start-date 2025-08-23 --end-date 2025-08-23 --max-messages 2 ---

--- Setting up database for ranked analysis ---
--- Inserted mock donation ---

--- Running command: poetry run python -m source.cli trigger-ranked-analysis --budget 10.0 --max-messages 1 ---
2025-09-02 15:22:13 - public_detective - [INFO] [-] - Logger configured with level: INFO
Triggering ranked analysis with a budget of 10.00 BRL.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Database engine not found, creating new instance...
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Using isolated schema: test_schema_2c04cb675eb94b669891715333093917
2025-09-02 15:22:14 - public_detective - [INFO] [-] - SQLAlchemy engine created successfully.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Google Gemini client configured successfully for schema 'Analysis'.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Starting ranked analysis job with a budget of 10.00 BRL.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Analysis run is limited to a maximum of 1 message(s).
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Zero-vote budget is 10.00 BRL.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Found 2 pending analyses.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Processing analysis bb5346ea-31c6-450a-b6b2-025196ade101 with estimated cost of 0.01 BRL.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Running specific analysis for analysis_id: bb5346ea-31c6-450a-b6b2-025196ade101
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Updating status for analysis bb5346ea-31c6-450a-b6b2-025196ade101 to ANALYSIS_IN_PROGRESS.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Analysis status updated successfully.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Recording new status 'ANALYSIS_IN_PROGRESS' for analysis_id bb5346ea-31c6-450a-b6b2-025196ade101.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Status history record created successfully.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - PublisherClient not found in cache, creating a new instance...
2025-09-02 15:22:14 - public_detective - [INFO] [-] - PublisherClient instance created for emulator at 127.0.0.1:8085
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Publishing to topic: projects/public-detective/topics/procurements-topic-604ad3f3baec48cdb47e67b7bfe370a0
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Published analysis request for analysis_id bb5346ea-31c6-450a-b6b2-025196ade101 to Pub/Sub.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Saving expense for analysis bb5346ea-31c6-450a-b6b2-025196ade101.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Expense for analysis bb5346ea-31c6-450a-b6b2-025196ade101 saved successfully.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Analysis bb5346ea-31c6-450a-b6b2-025196ade101 triggered. Remaining budget: 9.99 BRL. Zero-vote budget: 9.99 BRL.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Reached max_messages limit of 1. Stopping job.
2025-09-02 15:22:14 - public_detective - [INFO] [-] - Ranked analysis job completed.
Ranked analysis completed successfully!
--- Command finished: poetry run python -m source.cli trigger-ranked-analysis --budget 10.0 --max-messages 1 ---

--- Running command: poetry run python -m source.worker --max-messages 1 --timeout 5 --max-output-tokens None ---
2025-09-02 15:22:16 - public_detective - [INFO] [-] - Logger configured with level: INFO
2025-09-02 15:22:16 - public_detective - [INFO] [-] - Database engine not found, creating new instance...
2025-09-02 15:22:16 - public_detective - [INFO] [-] - Using isolated schema: test_schema_2c04cb675eb94b669891715333093917
2025-09-02 15:22:16 - public_detective - [INFO] [-] - SQLAlchemy engine created successfully.
2025-09-02 15:22:16 - public_detective - [INFO] [-] - Google Gemini client configured successfully for schema 'Analysis'.
2025-09-02 15:22:16 - public_detective - [INFO] [-] - SubscriberClient not found in cache, creating a new instance...
2025-09-02 15:22:16 - public_detective - [INFO] [-] - SubscriberClient instance created for emulator at 127.0.0.1:8085
2025-09-02 15:22:16 - public_detective - [INFO] [-] - Subscribing to subscription: projects/public-detective/subscriptions/procurements-subscription-604ad3f3baec48cdb47e67b7bfe370a0
2025-09-02 15:22:16 - public_detective - [INFO] [-] - Successfully subscribed to projects/public-detective/subscriptions/procurements-subscription-604ad3f3baec48cdb47e67b7bfe370a0. Waiting for messages...
2025-09-02 15:22:16 - public_detective - [INFO] [-] - Worker is now running and waiting for messages (timeout: 5s)...
2025-09-02 15:22:17 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Received message ID: 54 for procurement 43776491000170-1-000252/2025 (analysis_id: bb5346ea-31c6-450a-b6b2-025196ade101). Attempting to process...
2025-09-02 15:22:17 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Starting analysis for procurement 43776491000170-1-000252/2025 version 1...
2025-09-02 15:22:17 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Found metadata for 3 active document(s).
2025-09-02 15:22:21 - public_detective - [WARNING] [-] - Worker timed out after 5 seconds of inactivity.
2025-09-02 15:22:21 - public_detective - [INFO] [-] - Stopping worker...
2025-09-02 15:22:21 - public_detective - [INFO] [-] - Worker has stopped gracefully.
2025-09-02 15:22:24 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Sending request to Gemini API for 'MAPA.pdf'.
2025-09-02 15:22:24 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Uploading file 'MAPA.pdf' to Gemini File API...
2025-09-02 15:22:25 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File uploaded successfully: files/ih8w7yq6e7ma
2025-09-02 15:22:25 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Sending request to Gemini API for 'DESPACHO.pdf'.
2025-09-02 15:22:25 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Uploading file 'DESPACHO.pdf' to Gemini File API...
2025-09-02 15:22:26 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File uploaded successfully: files/10ln0d32zshl
2025-09-02 15:22:26 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Sending request to Gemini API for 'OF_077464_ASSINADO.pdf'.
2025-09-02 15:22:26 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Uploading file 'OF_077464_ASSINADO.pdf' to Gemini File API...
2025-09-02 15:22:27 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File uploaded successfully: files/8o9n1ezwb0pw
2025-09-02 15:22:27 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - max_output_tokens is None, so no limit will be applied.
2025-09-02 15:23:38 - public_detective - [WARNING] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - No direct function_call found, attempting to parse from text response.
2025-09-02 15:23:38 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Successfully parsed JSON data from text response.
2025-09-02 15:23:38 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Deleting uploaded file: files/ih8w7yq6e7ma
2025-09-02 15:23:38 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Deleting uploaded file: files/10ln0d32zshl
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Deleting uploaded file: files/8o9n1ezwb0pw
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - GCS client not found in cache, creating new instance...
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - GCS client configured for emulator at http://127.0.0.1:8086
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - GCS client created successfully.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Uploading file to GCS: gs://procurements/test-run-604ad3f3baec48cdb47e67b7bfe370a0/43776491000170-1-000252/2025/20250902152339/analysis_report.json
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File uploaded successfully.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Updating analysis for analysis_id bb5346ea-31c6-450a-b6b2-025196ade101.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Analysis updated successfully for ID: bb5346ea-31c6-450a-b6b2-025196ade101.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Uploading file to GCS: gs://procurements/test-run-604ad3f3baec48cdb47e67b7bfe370a0/43776491000170-1-000252/2025/20250902152339/files/MAPA.pdf
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File uploaded successfully.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Saving file record for MAPA.pdf.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File record saved successfully.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Uploading file to GCS: gs://procurements/test-run-604ad3f3baec48cdb47e67b7bfe370a0/43776491000170-1-000252/2025/20250902152339/files/DESPACHO.pdf
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File uploaded successfully.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Saving file record for DESPACHO.pdf.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File record saved successfully.
2025-09-02 15:23:39 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Uploading file to GCS: gs://procurements/test-run-604ad3f3baec48cdb47e67b7bfe370a0/43776491000170-1-000252/2025/20250902152339/files/OF_077464_ASSINADO.pdf
2025-09-02 15:23:40 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File uploaded successfully.
2025-09-02 15:23:40 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Saving file record for OF_077464_ASSINADO.pdf.
2025-09-02 15:23:40 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - File record saved successfully.
2025-09-02 15:23:40 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Successfully completed analysis for 43776491000170-1-000252/2025.
2025-09-02 15:23:40 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Updating status for analysis bb5346ea-31c6-450a-b6b2-025196ade101 to ANALYSIS_SUCCESSFUL.
2025-09-02 15:23:40 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Analysis status updated successfully.
2025-09-02 15:23:40 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Recording new status 'ANALYSIS_SUCCESSFUL' for analysis_id bb5346ea-31c6-450a-b6b2-025196ade101.
2025-09-02 15:23:40 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Status history record created successfully.
2025-09-02 15:23:40 - public_detective - [INFO] [43776491000170-1-000252/2025:bb5346ea-31c6-450a-b6b2-025196ade101:3f656c05] - Message 54 for procurement 43776491000170-1-000252/2025 processed successfully. Sending ACK.
2025-09-02 15:23:40 - public_detective - [INFO] [None] - Reached message limit (1). Stopping worker...
--- Command finished: poetry run python -m source.worker --max-messages 1 --timeout 5 --max-output-tokens None ---

--- Validating data in tables ---
Successfully completed analyses: 1/1
--- budget_ledgers table check passed with 1 entries ---

--- E2E test flow completed successfully ---

--- Critical Analysis Data Dump ---

--- Dumping table: budget_ledgers ---
[
  {
    "id": "5cb4cf7b-f56a-4462-ae34-e2f5c1045132",
    "transaction_type": "EXPENSE",
    "amount": "0.0079125000",
    "related_analysis_id": "bb5346ea-31c6-450a-b6b2-025196ade101",
    "related_donation_id": "None",
    "description": "Análise da licitação 43776491000170-1-000252/2025 (v1).",
    "created_at": "2025-09-02 15:22:14.278437+00:00"
  }
]

--- Dumping table: donations ---
[
  {
    "id": "3671098d-6ae3-4bc3-87b0-be64460be5a2",
    "donor_identifier": "E2E_TEST_DONOR",
    "amount": "15.0000000000",
    "transaction_id": "E2E_TEST_TX_ID",
    "created_at": "2025-09-02 15:22:11.742971+00:00"
  }
]

--- Dumping table: file_records ---
[
  {
    "id": "217a2203-a6b1-4de0-974c-78604122870d",
    "created_at": "2025-09-02 15:23:39.802556+00:00",
    "updated_at": "2025-09-02 15:23:39.802556+00:00",
    "analysis_id": "bb5346ea-31c6-450a-b6b2-025196ade101",
    "file_name": "MAPA.pdf",
    "gcs_path": "test-run-604ad3f3baec48cdb47e67b7bfe370a0/43776491000170-1-000252/2025/20250902152339/files/MAPA.pdf",
    "extension": "pdf",
    "size_bytes": "286488",
    "nesting_level": "0",
    "included_in_analysis": "True",
    "exclusion_reason": "None",
    "prioritization_logic": "Sem priorização."
  },
  {
    "id": "e06b257e-d7b7-4697-b1aa-2b5c9053d706",
    "created_at": "2025-09-02 15:23:39.824812+00:00",
    "updated_at": "2025-09-02 15:23:39.824812+00:00",
    "analysis_id": "bb5346ea-31c6-450a-b6b2-025196ade101",
    "file_name": "DESPACHO.pdf",
    "gcs_path": "test-run-604ad3f3baec48cdb47e67b7bfe370a0/43776491000170-1-000252/2025/20250902152339/files/DESPACHO.pdf",
    "extension": "pdf",
    "size_bytes": "263549",
    "nesting_level": "0",
    "included_in_analysis": "True",
    "exclusion_reason": "None",
    "prioritization_logic": "Sem priorização."
  },
  {
    "id": "271b80f0-16a4-46da-905b-c3762cd47c8f",
    "created_at": "2025-09-02 15:23:40.177927+00:00",
    "updated_at": "2025-09-02 15:23:40.177927+00:00",
    "analysis_id": "bb5346ea-31c6-450a-b6b2-025196ade101",
    "file_name": "OF_077464_ASSINADO.pdf",
    "gcs_path": "test-run-604ad3f3baec48cdb47e67b7bfe370a0/43776491000170-1-000252/2025/20250902152339/files/OF_077464_ASSINADO.pdf",
    "extension": "pdf",
    "size_bytes": "4223435",
    "nesting_level": "0",
    "included_in_analysis": "True",
    "exclusion_reason": "None",
    "prioritization_logic": "Sem priorização."
  }
]

--- Dumping table: procurement_analyses ---
[
  {
    "analysis_id": "5cb0a208-06ad-4c45-88e6-e921778363d1",
    "created_at": "2025-09-02 15:21:59.474519+00:00",
    "updated_at": "2025-09-02 15:21:59.474519+00:00",
    "procurement_control_number": "43776491000170-1-000251/2025",
    "version_number": "1",
    "analysis_date": "2025-09-02 15:21:59.474519+00:00",
    "status": "PENDING_ANALYSIS",
    "risk_score": "None",
    "risk_score_rationale": "None",
    "procurement_summary": "None",
    "analysis_summary": "None",
    "red_flags": "None",
    "seo_keywords": "None",
    "warnings": "None",
    "document_hash": "afb7f05955684cb363a531e3502569bc786b7b08979178e06b546314be987654",
    "original_documents_gcs_path": "None",
    "processed_documents_gcs_path": "None",
    "input_tokens_used": "2973",
    "output_tokens_used": "0",
    "votes_count": "0"
  },
  {
    "analysis_id": "bb5346ea-31c6-450a-b6b2-025196ade101",
    "created_at": "2025-09-02 15:22:09.450571+00:00",
    "updated_at": "2025-09-02 15:23:40.181483+00:00",
    "procurement_control_number": "43776491000170-1-000252/2025",
    "version_number": "1",
    "analysis_date": "2025-09-02 15:22:09.450571+00:00",
    "status": "ANALYSIS_SUCCESSFUL",
    "risk_score": "7",
    "risk_score_rationale": "A nota 7 (Risco Alto) é atribuída devido à combinação de evidências claras de sobrepreço e restrição à competitividade. A adjudicação de todos os itens a um único fornecedor, apesar de este apresentar preços muito superiores aos da concorrência para produtos de alto volume, resultou em um prejuízo potencial superior a 40% do valor do contrato. Adicionalmente, a especificação direta de marcas para alguns itens, sem a devida justificativa técnica, compromete a isonomia e a busca pela proposta mais vantajosa, levantando suspeitas de direcionamento do certame.",
    "procurement_summary": "O processo refere-se à aquisição de diversos Equipamentos de Proteção Individual (EPIs) pela CETESB, por meio de dispensa de licitação. A contratação, no valor de R$ 23.739,50, foi adjudicada em sua totalidade à empresa BUNZL Equipamentos para Proteção Individual Ltda. O objetivo era suprir as necessidades de diversas áreas da companhia.",
    "analysis_summary": "A análise da dispensa de licitação revelou indícios significativos de sobrepreço e restrição à competitividade. A adjudicação de todos os itens a um único fornecedor, apesar de propostas mais vantajosas de outras empresas para itens de grande volume, gerou um potencial prejuízo ao erário. Adicionalmente, a especificação de marcas em alguns itens, sem justificativa técnica aparente, comprometeu a isonomia do processo.",
    "red_flags": "[{'category': 'SOBREPRECO', 'description': \"Preço contratado para o item 'Avental de Segurança' é 733% superior à proposta de menor valor apresentada no processo.\", 'evidence_quote': 'Item: 0004, Descrição do material: AVENTAL DE SEGURANCA, CONFECCIONADO EM TELA SINTETICA (TREVIRA) REVESTIDA DE PVC NA FACE EXTERNA OU EM AMBAS AS FACES..., Preço Unitário: 65,000000', 'auditor_reasoning': \"A contratação do item 'Avental de Segurança' pelo valor de R$ 65,00, quando havia uma proposta válida no mesmo processo por R$ 7,80 (da empresa ICALSEG), representa um sobrepreço de 733%. A adjudicação por lote único mostrou-se antieconômica, pois a aceitação de um preço tão elevado, sem uma justificativa técnica robusta para a desclassificação das ofertas mais baratas, indica falha grave no julgamento da proposta mais vantajosa e potencial dano ao erário.\"}, {'category': 'SOBREPRECO', 'description': \"O preço unitário contratado para 'Luva Nitrílica' (R$ 1,43) é 110% superior ao menor preço cotado (R$ 0,68) para o mesmo item.\", 'evidence_quote': 'Item: 0007, Descrição do material: LUVA NITRILICA, TAMANHO 10 OU EG OU XG LUVA DE SEGURANÇA PARA PROCEDIMENTOS NÃO CIRÚRGICOS..., Preço Unitário: 1,430000', 'auditor_reasoning': 'Para um item de alta demanda (total de 8.200 unidades), a administração optou por contratar as luvas por um preço 110% superior ao menor valor cotado (R$ 0,68 da empresa SERT EPI). Essa decisão resultou em um custo adicional de mais de R$ 6.000,00. A ausência de uma análise comparativa que justificasse a economicidade da contratação global em detrimento da contratação por item evidencia gestão ineficiente dos recursos públicos.'}, {'category': 'RESTRICAO_COMPETITIVIDADE', 'description': \"Especificação de marca e modelo ('3M') no descritivo do item 'Respirador', sem justificativa técnica.\", 'evidence_quote': 'REFERENCIA: LINHA 7500 DA 3M - 7501 (PEQUENO), 7502 (MEDIO), 7503 (GRANDE)- CA 12011 MARCA 3M CA 12011', 'auditor_reasoning': \"A especificação de uma marca e linha de produto ('LINHA 7500 DA 3M') no descritivo do item, sem a apresentação de uma justificativa técnica formal que comprove a sua singularidade e essencialidade, restringe indevidamente a participação de outros fornecedores. Essa prática fere o princípio da isonomia e da competitividade, podendo direcionar a contratação para um fornecedor específico.\"}]",
    "seo_keywords": "['Licitação CETESB EPI', 'Compra protetores pessoais São Paulo', 'Dispensa de licitação processo 006733/2025-59', 'Análise licitação BUNZL EPI', 'Irregularidades contrato CETESB', 'Sobrepreço em compra de EPIs', 'Auditoria licitação pública São Paulo', 'Restrição de competitividade CETESB']",
    "warnings": "[]",
    "document_hash": "e20fba61c43458121ed841c4fccf297948943825f2c5c92fcd9601dd441019b2",
    "original_documents_gcs_path": "test-run-604ad3f3baec48cdb47e67b7bfe370a0/43776491000170-1-000252/2025/20250902152339/files/",
    "processed_documents_gcs_path": "test-run-604ad3f3baec48cdb47e67b7bfe370a0/43776491000170-1-000252/2025/20250902152339/analysis_report.json",
    "input_tokens_used": "6330",
    "output_tokens_used": "1228",
    "votes_count": "0"
  }
]

--- Dumping table: procurement_analysis_status_history ---
[
  {
    "id": "68325e4b-eadb-4c22-8461-ddfa16f5d4b2",
    "analysis_id": "5cb0a208-06ad-4c45-88e6-e921778363d1",
    "status": "PENDING_ANALYSIS",
    "details": "Pre-analysis completed.",
    "created_at": "2025-09-02 15:21:59.485027+00:00"
  },
  {
    "id": "b93f3fbb-1751-4988-82a5-46f2e91364b4",
    "analysis_id": "bb5346ea-31c6-450a-b6b2-025196ade101",
    "status": "PENDING_ANALYSIS",
    "details": "Pre-analysis completed.",
    "created_at": "2025-09-02 15:22:09.453834+00:00"
  },
  {
    "id": "fa1e6352-abb9-4910-9c39-ca86cdb3a9d0",
    "analysis_id": "bb5346ea-31c6-450a-b6b2-025196ade101",
    "status": "ANALYSIS_IN_PROGRESS",
    "details": "Worker picked up the task.",
    "created_at": "2025-09-02 15:22:14.232128+00:00"
  },
  {
    "id": "c9dd6b02-4b86-4cf9-8e0d-8e4eb23ea24d",
    "analysis_id": "bb5346ea-31c6-450a-b6b2-025196ade101",
    "status": "ANALYSIS_SUCCESSFUL",
    "details": "Analysis completed successfully.",
    "created_at": "2025-09-02 15:23:40.184050+00:00"
  }
]

--- Dumping table: procurements ---
[
  {
    "procurement_id": "6247d06e-c764-49b0-9695-b2d41d03ff84",
    "created_at": "2025-09-02 15:21:59.303726+00:00",
    "updated_at": "2025-09-02 15:21:59.303726+00:00",
    "pncp_control_number": "43776491000170-1-000251/2025",
    "proposal_opening_date": "None",
    "proposal_closing_date": "None",
    "object_description": "PILHA, TIPO ALCALINA",
    "total_awarded_value": "5425.6",
    "is_srp": "False",
    "procurement_year": "2025",
    "procurement_sequence": "251",
    "pncp_publication_date": "2025-08-23 11:39:14+00:00",
    "last_update_date": "2025-08-23 11:39:14+00:00",
    "modality_id": "8",
    "procurement_status_id": "1",
    "total_estimated_value": "5594.08",
    "version_number": "1",
    "raw_data": "{'srp': False, 'processo': '005536/2025-82', 'anoCompra': 2025, 'amparoLegal': {'nome': 'Lei 13.303/2016, Art. 29, II', 'codigo': 85, 'descricao': 'Dispensa de Licitação: para outros serviços e compras de valor até R$ 50.000,00 (cinquenta mil reais) e para alienações, nos casos previstos nesta Lei, desde que não se refiram a parcelas de um mesmo serviço, compra ou alienação de maior vulto que possa ser realizado de uma só vez'}, 'usuarioNome': 'Compras.gov.br', 'dataInclusao': '2025-08-23T11:39:14', 'modalidadeId': 8, 'numeroCompra': '229', 'objetoCompra': 'PILHA, TIPO ALCALINA', 'unidadeOrgao': {'ufNome': 'São Paulo', 'ufSigla': 'SP', 'codigoIbge': '3550308', 'nomeUnidade': 'ESP-CETESB-CIA. AMBIENTAL DO EST DE S.PAULO', 'codigoUnidade': '263101', 'municipioNome': 'São Paulo'}, 'modoDisputaId': 5, 'orgaoEntidade': {'cnpj': '43776491000170', 'poderId': 'E', 'esferaId': 'E', 'razaoSocial': '(UO) ESP-CETESB-CIA AMBIENTAL DO EST.DE SP'}, 'modalidadeNome': 'Dispensa', 'orgaoSubRogado': None, 'dataAtualizacao': '2025-08-23T11:39:14', 'modoDisputaNome': 'Não se aplica', 'sequencialCompra': 251, 'situacaoCompraId': 1, 'unidadeSubRogada': None, 'linkSistemaOrigem': None, 'dataPublicacaoPncp': '2025-08-23T11:39:14', 'numeroControlePNCP': '43776491000170-1-000251/2025', 'situacaoCompraNome': 'Divulgada no PNCP', 'valorTotalEstimado': 5594.08, 'fontesOrcamentarias': [], 'dataAberturaProposta': None, 'valorTotalHomologado': 5425.6, 'dataAtualizacaoGlobal': '2025-08-23T11:42:17', 'informacaoComplementar': None, 'linkProcessoEletronico': None, 'justificativaPresencial': None, 'dataEncerramentoProposta': None, 'tipoInstrumentoConvocatorioNome': 'Ato que autoriza a Contratação Direta', 'tipoInstrumentoConvocatorioCodigo': 3}",
    "content_hash": "549a0639e0644e4ca5b01e3be17a36eda3aef2f69b6e44980154ed1903c3aa97"
  },
  {
    "procurement_id": "915cb69f-f01a-4cd5-84dd-be06b47a39e8",
    "created_at": "2025-09-02 15:22:07.113954+00:00",
    "updated_at": "2025-09-02 15:22:07.113954+00:00",
    "pncp_control_number": "43776491000170-1-000252/2025",
    "proposal_opening_date": "None",
    "proposal_closing_date": "None",
    "object_description": "PROTETORES PESSOAIS DIVERSOS",
    "total_awarded_value": "24315.5",
    "is_srp": "False",
    "procurement_year": "2025",
    "procurement_sequence": "252",
    "pncp_publication_date": "2025-08-23 16:34:53+00:00",
    "last_update_date": "2025-08-23 16:34:53+00:00",
    "modality_id": "8",
    "procurement_status_id": "1",
    "total_estimated_value": "24315.5",
    "version_number": "1",
    "raw_data": "{'srp': False, 'processo': '006733/2025-59', 'anoCompra': 2025, 'amparoLegal': {'nome': 'Lei 13.303/2016, Art. 29, II', 'codigo': 85, 'descricao': 'Dispensa de Licitação: para outros serviços e compras de valor até R$ 50.000,00 (cinquenta mil reais) e para alienações, nos casos previstos nesta Lei, desde que não se refiram a parcelas de um mesmo serviço, compra ou alienação de maior vulto que possa ser realizado de uma só vez'}, 'usuarioNome': 'Compras.gov.br', 'dataInclusao': '2025-08-23T16:34:53', 'modalidadeId': 8, 'numeroCompra': '230', 'objetoCompra': 'PROTETORES PESSOAIS DIVERSOS', 'unidadeOrgao': {'ufNome': 'São Paulo', 'ufSigla': 'SP', 'codigoIbge': '3550308', 'nomeUnidade': 'ESP-CETESB-CIA. AMBIENTAL DO EST DE S.PAULO', 'codigoUnidade': '263101', 'municipioNome': 'São Paulo'}, 'modoDisputaId': 5, 'orgaoEntidade': {'cnpj': '43776491000170', 'poderId': 'E', 'esferaId': 'E', 'razaoSocial': '(UO) ESP-CETESB-CIA AMBIENTAL DO EST.DE SP'}, 'modalidadeNome': 'Dispensa', 'orgaoSubRogado': None, 'dataAtualizacao': '2025-08-23T16:34:53', 'modoDisputaNome': 'Não se aplica', 'sequencialCompra': 252, 'situacaoCompraId': 1, 'unidadeSubRogada': None, 'linkSistemaOrigem': None, 'dataPublicacaoPncp': '2025-08-23T16:34:53', 'numeroControlePNCP': '43776491000170-1-000252/2025', 'situacaoCompraNome': 'Divulgada no PNCP', 'valorTotalEstimado': 24315.5, 'fontesOrcamentarias': [], 'dataAberturaProposta': None, 'valorTotalHomologado': 24315.5, 'dataAtualizacaoGlobal': '2025-08-23T16:38:03', 'informacaoComplementar': None, 'linkProcessoEletronico': None, 'justificativaPresencial': None, 'dataEncerramentoProposta': None, 'tipoInstrumentoConvocatorioNome': 'Ato que autoriza a Contratação Direta', 'tipoInstrumentoConvocatorioCodigo': 3}",
    "content_hash": "ac4ee5db98b436504d028a31c771ed930d941803cf71f903fc130ec03ada2c85"
  }
]

--- Dumping table: votes ---
[]

--- Data Dump Complete ---
.
--- Tearing down E2E test environment ---
Deleted subscription: procurements-subscription-604ad3f3baec48cdb47e67b7bfe370a0
Deleted topic: procurements-topic-604ad3f3baec48cdb47e67b7bfe370a0
E2E test environment torn down.

--- Tearing down database session ---
Dropping schema test_schema_2c04cb675eb94b669891715333093917...
Database session torn down.


======================== 1 passed in 120.39s (0:02:00) =========================
